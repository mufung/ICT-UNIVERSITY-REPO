<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Teacher Dashboard</title>
</head>
<body>

<h1>Teacher Dashboard</h1>

<form id="uploadForm">
  <input type="text" id="studentId" placeholder="Student ID" required /><br><br>
  <input type="text" id="courseCode" placeholder="Course Code" required /><br><br>
  <input type="text" id="academicYear" placeholder="Academic Year" required /><br><br>
  <input type="text" id="department" placeholder="Department" required /><br><br>

  <input type="file" id="fileInput" accept=".json" required /><br><br>

  <button type="submit">Submit Results</button>
</form>

<p id="status"></p>

<script>
/**
 * ‚úÖ CORRECT API ENDPOINT
 * MUST MATCH: POST /results
 */
const API_URL = "https://evqtbna09d.execute-api.us-west-1.amazonaws.com/prod/results";

document.getElementById("uploadForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const status = document.getElementById("status");
  status.innerText = "Uploading...";

  try {
    // üîê GET COGNITO ID TOKEN
    const idToken = localStorage.getItem("idToken");
    if (!idToken) {
      throw new Error("User not authenticated (missing idToken)");
    }

    // üìÇ READ FILE
    const fileInput = document.getElementById("fileInput");
    if (!fileInput.files.length) {
      throw new Error("No file selected");
    }

    const fileText = await fileInput.files[0].text();
    const resultsJson = JSON.parse(fileText);

    // üì¶ BUILD PAYLOAD
    const payload = {
      studentId: document.getElementById("studentId").value,
      courseCode: document.getElementById("courseCode").value,
      academicYear: document.getElementById("academicYear").value,
      department: document.getElementById("department").value,
      results: resultsJson
    };

    // üöÄ SEND REQUEST
    const response = await fetch(API_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${idToken}`
      },
      body: JSON.stringify(payload)
    });

    const data = await response.json();

    if (!response.ok) {
      console.error("API ERROR RESPONSE:", data);
      throw new Error(data.message || "API error");
    }

    status.innerText = "‚úÖ Upload successful";

  } catch (err) {
    console.error("UPLOAD ERROR:", err);
    status.innerText = "‚ùå Upload failed (check console)";
  }
});
</script>

</body>
</html>
